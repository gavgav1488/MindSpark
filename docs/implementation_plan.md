# План реализации недостающих функций для MindSpark

## 1. Система уведомлений

### Техническое описание
Система уведомлений будет реализована с использованием:
- Supabase Realtime для push-уведомлений
- Веб-уведомлений браузера для показа уведомлений
- Email-уведомлений через внешние сервисы (например, SendGrid)

### Таблицы в базе данных
```sql
-- Таблица для хранения уведомлений
create table if not exists notifications (
  id bigint generated by default as identity primary key,
 user_id uuid references auth.users(id) on delete cascade not null,
  title text not null,
  message text not null,
  type text check (type in ('reminder', 'achievement', 'system')) not null,
  is_read boolean default false,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);
```

### Компоненты
- NotificationProvider - контекст для управления уведомлениями
- NotificationToast - компонент для показа всплывающих уведомлений
- NotificationList - компонент для отображения истории уведомлений

### API функции
- `sendNotification()` - отправка уведомления пользователю
- `getUnreadNotifications()` - получение непрочитанных уведомлений
- `markAsRead()` - пометка уведомления как прочитанного
- `markAllAsRead()` - пометка всех уведомлений как прочитанных

## 2. Система достижений

### Техническое описание
Система достижений будет отслеживать прогресс пользователя и выдавать достижения за выполнение определенных действий:
- 7 дней подряд отмечено настроение
- 30 дней подряд отмечено настроение
- Создание 5 привычек
- Выполнение привычки 10 дней подряд
- и т.д.

### Таблицы в базе данных
```sql
-- Таблица для хранения типов достижений
create table if not exists achievement_templates (
  id bigint generated by default as identity primary key,
 name text not null,
  description text not null,
  icon text,
  target_condition text not null, -- условие для получения достижения
  points integer default 0 -- очки, начисляемые за достижение
);

-- Таблица для хранения полученных достижений пользователями
create table if not exists user_achievements (
  id bigint generated by default as identity primary key,
 user_id uuid references auth.users(id) on delete cascade not null,
 achievement_id bigint references achievement_templates(id) on delete cascade not null,
 earned_at timestamp with time zone default timezone('utc'::text, now()) not null,
  unique(user_id, achievement_id) -- пользователь может получить одно достижение только один раз
);
```

### Компоненты
- AchievementTracker - компонент для проверки условий достижений
- AchievementNotifier - компонент для уведомления о получении достижения

### API функции
- `getAchievementTemplates()` - получение всех шаблонов достижений
- `getUserAchievements()` - получение достижений конкретного пользователя
- `awardAchievement()` - начисление достижения пользователю
- `checkAchievements()` - проверка условий для получения достижений

## 3. Система профилей пользователей

### Техническое описание
Система профилей будет расширять стандартные данные аутентификации Supabase, добавляя:
- Имя пользователя
- Фотографию профиля
- Предпочтения (например, цветовая тема)
- Статистика пользователя

### Таблицы в базе данных
```sql
-- Таблица профилей пользователей (расширение auth.users)
create table if not exists user_profiles (
  id uuid references auth.users(id) on delete cascade primary key,
  username text unique,
 full_name text,
  avatar_url text,
  theme_preference text check (theme_preference in ('light', 'dark', 'auto')) default 'auto',
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  updated_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- Триггер для автоматического создания профиля при регистрации пользователя
create or replace function public.handle_new_user()
returns trigger
language plpgsql
as $$
begin
  insert into public.user_profiles (id, username, full_name, avatar_url)
  values (new.id, new.email, '', '');
  return new;
end;
$$;

-- Триггер на событие создания пользователя
create trigger on_auth_user_created
  after insert on auth.users
 for each row execute procedure public.handle_new_user();
```

### Компоненты
- ProfileSettings - форма для редактирования профиля
- UserProfile - компонент для отображения профиля пользователя

### API функции
- `getUserProfile()` - получение профиля пользователя
- `updateUserProfile()` - обновление профиля пользователя
- `updateAvatar()` - обновление аватара пользователя

## 4. Система статистики и аналитики

### Техническое описание
Система будет собирать и визуализировать статистику:
- Среднее настроение за определенные периоды
- Прогресс по привычкам
- Тенденции в настроении
- Статистика по достижениям

### Компоненты
- MoodAnalytics - компонент для аналитики настроения
- HabitAnalytics - компонент для аналитики привычек
- DashboardStats - компонент для отображения общей статистики

### API функции
- `getMoodAnalytics()` - получение аналитики по настроению
- `getHabitAnalytics()` - получение аналитики по привычкам
- `getUserStatistics()` - получение общей статистики пользователя

## 5. Система геймификации

### Техническое описание
Система геймификации будет включать:
- Систему очков за активность
- Уровни пользователя, повышаемые за набранные очки
- Ежедневные и еженедельные цели
- Бонусы за последовательность (streaks)

### Таблицы в базе данных
```sql
-- Таблица для хранения игровой статистики пользователей
create table if not exists user_game_stats (
  user_id uuid references auth.users(id) on delete cascade primary key,
  points integer default 0,
  level integer default 1,
  current_streak integer default 0,
  max_streak integer default 0,
  daily_goal_completed boolean default false,
  weekly_goal_completed boolean default false,
  last_activity_date date,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  updated_at timestamp with time zone default timezone('utc'::text, now()) not null
);
```

### Компоненты
- GameStatsDisplay - компонент для отображения игровой статистики
- LevelProgress - компонент для отображения прогресса уровня
- StreakCounter - компонент для отображения текущей серии

### API функции
- `getUserGameStats()` - получение игровой статистики пользователя
- `updateGameStats()` - обновление игровой статистики
- `awardPoints()` - начисление очков пользователю
- `checkAndUpdateStreak()` - проверка и обновление серии

## 6. Интеграция компонентов

### Middleware
- Проверка аутентификации
- Обновление статистики активности
- Проверка условий для достижений

### Страницы
- Профиль пользователя с настройками
- Страница статистики
- Страница достижений
- Страница настроек уведомлений

## 7. Порядок реализации

### Этап 1: Базовая инфраструктура
1. Создание дополнительных таблиц в Supabase
2. Реализация API функций для работы с новыми сущностями
3. Настройка триггеров для автоматического создания профилей

### Этап 2: Backend логика
1. Реализация систем достижений и геймификации
2. Реализация системы уведомлений
3. Реализация системы статистики

### Этап 3: Frontend компоненты
1. Создание компонентов для профиля пользователя
2. Создание компонентов для отображения статистики
3. Создание компонентов для уведомлений и достижений

### Этап 4: Интеграция
1. Интеграция новых компонентов в существующие страницы
2. Добавление навигации к новым страницам
3. Тестирование функциональности

### Этап 5: Улучшения
1. Добавление анимаций и улучшений UX
2. Оптимизация производительности
3. Добавление документации